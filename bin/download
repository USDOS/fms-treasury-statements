#!/bin/sh
set -e

# Datestamp from input
if [ -z "$FMS" ]; then
  echo You must activate the FMS environment first.
elif [ "$#" = 1 ]; then
  datestamp=$(date -d "$1" +%y%m%d00)
else
  echo "USAGE: $0 [datestamp]"
  exit 1
fi

file=$(date -d "$1" +"$FMS/archive/%Y%m%d.txt")

# Skip things that are broken. I suspect that these are holidays.
echo '
20120102.txt
20120116.txt
20120220.txt
20120528.txt
20120704.txt
20120903.txt
20121008.txt
20121112.txt
20121122.txt
20121225.txt
' | grep $(basename "$file") > /dev/null && exit

# Skip things that are done.
test -e "$file" && exit

# Download, finally.
get() {
  sleep 0.5s
  wget -w 8 -O "$file" "https://www.fms.treas.gov/fmsweb/viewDTSFiles?dir=$1&fname=$datestamp.txt"
}

# Try the archive
get a && exit

# Try the live one
get w && exit

# Clean up because it didn't work.
rm "$file"
exit 1

